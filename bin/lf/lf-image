#!/bin/bash

## TODO idea have image preview and lfcd work in one command

## lf wrapper to make image previews work with ueberzug
set -e

cleanup() {
    exec 3>&-
	rm "$FIFO_UEBERZUG"
}

preview () {
	#echo $1
	if [ -n "$SSH_CLIENT" ] || [ -n "$SSH_TTY" ]; then
		lf "$1" "$@"
	else
		[ ! -d "$HOME/.cache/lf" ] && mkdir -p "$HOME/.cache/lf"
		export FIFO_UEBERZUG="$HOME/.cache/lf/ueberzug-$$"
		mkfifo "$FIFO_UEBERZUG"
		ueberzug layer -s <"$FIFO_UEBERZUG" -p json &
		exec 3>"$FIFO_UEBERZUG"
		trap cleanup HUP INT QUIT TERM PWR EXIT
		lf "$1" "$@" 3>&-
	fi
}

## If you switch to a directory in lf and quit it the terminal will be
## switchting to this directory
lfcd () {
    tmp="$(mktemp)"
		preview -last-dir-path="$tmp"
    #lf -last-dir-path="$tmp" "$@"
    if [ -f "$tmp" ]; then
        dir="$(cat "$tmp")"
        rm -f "$tmp" >/dev/null
				## TODO how to cd into it
        [ -d "$dir" ] && [ "$dir" != "$(pwd)" ] && cd "$dir"
    fi
		echo "Last dir: $dir"
}
lfcd
